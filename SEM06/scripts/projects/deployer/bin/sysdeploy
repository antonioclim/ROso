#!/bin/bash
#===============================================================================
# sysdeploy - System Deployment Wrapper
#===============================================================================
# Wrapper script pentru deployer.sh - permite rulare din orice director
# Parte din CAPSTONE Project - Seminar 11-12 Sisteme de Operare
#
# Utilizare:
#   sysdeploy [--config FILE] [OPTIONS] ACTION [ARGS]
#   sysdeploy deploy --service myapp --source /path/to/app
#   sysdeploy rollback myapp
#   sysdeploy status myapp
#   sysdeploy health
#
# Instalare:
#   sudo cp bin/sysdeploy /usr/local/bin/
#   sudo chmod +x /usr/local/bin/sysdeploy
#
# Copyright (c) 2024 - Educational Use Only
#===============================================================================

set -euo pipefail

# Detectare locație script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Căutare deployer.sh în locații standard
find_deployer() {
    local locations=(
        "${SCRIPT_DIR}/../deployer.sh"
        "/opt/deployer/deployer.sh"
        "/usr/local/share/deployer/deployer.sh"
        "${HOME}/.local/share/deployer/deployer.sh"
        "/etc/deployer/deployer.sh"
    )
    
    for loc in "${locations[@]}"; do
        if [[ -f "$loc" && -x "$loc" ]]; then
            echo "$loc"
            return 0
        fi
    done
    
    return 1
}

# Căutare configurare în locații standard
find_config() {
    local locations=(
        "${SCRIPT_DIR}/../etc/deployer.conf"
        "/etc/deployer/deployer.conf"
        "/opt/deployer/etc/deployer.conf"
        "${HOME}/.config/deployer/deployer.conf"
        "${HOME}/.deployer.conf"
    )
    
    for loc in "${locations[@]}"; do
        if [[ -f "$loc" ]]; then
            echo "$loc"
            return 0
        fi
    done
    
    return 1
}

# Main
main() {
    local deployer_script
    local config_file
    local config_arg=""
    
    # Găsire deployer.sh
    if ! deployer_script=$(find_deployer); then
        echo "EROARE: Nu s-a găsit deployer.sh" >&2
        echo "Instalați deployer în /opt/deployer/ sau setați PATH corect" >&2
        exit 1
    fi
    
    # Verificare dacă utilizatorul a specificat --config
    local has_config=false
    for arg in "$@"; do
        if [[ "$arg" == "--config" || "$arg" == "-c" ]]; then
            has_config=true
            break
        fi
    done
    
    # Dacă nu e specificat --config, căutăm automat
    if ! $has_config; then
        if config_file=$(find_config); then
            config_arg="--config $config_file"
        fi
    fi
    
    # Execuție deployer cu argumente
    if [[ -n "$config_arg" ]]; then
        exec "$deployer_script" $config_arg "$@"
    else
        exec "$deployer_script" "$@"
    fi
}

main "$@"
