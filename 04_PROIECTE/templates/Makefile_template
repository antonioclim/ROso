#===============================================================================
# Makefile Template - Proiect SO
# ASE București - CSIE
#===============================================================================

# Configurare
SHELL := /bin/bash
.SHELLFLAGS := -eu -o pipefail -c

# Variabile proiect
NAME := $(shell basename $(CURDIR))
VERSION := 1.0.0
INSTALL_DIR := $(HOME)/.local/bin

# Directoare
SRC_DIR := src
LIB_DIR := $(SRC_DIR)/lib
TEST_DIR := tests
DOC_DIR := docs

# Fișiere
MAIN := $(SRC_DIR)/main.sh
SCRIPTS := $(wildcard $(SRC_DIR)/*.sh) $(wildcard $(LIB_DIR)/*.sh)
TESTS := $(wildcard $(TEST_DIR)/test_*.sh)

# Culori (pentru output frumos)
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m

#---------------------------------------
# Targets principale
#---------------------------------------

.PHONY: all
all: lint test ## Verificare completă (lint + test)

.PHONY: help
help: ## Afișează acest mesaj de ajutor
	@echo "╔══════════════════════════════════════════════╗"
	@echo "║     $(NAME) - Makefile Help                  ║"
	@echo "╚══════════════════════════════════════════════╝"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""

#---------------------------------------
# Dezvoltare
#---------------------------------------

.PHONY: lint
lint: ## Verifică calitatea codului cu ShellCheck
	@echo -e "$(YELLOW)═══ ShellCheck ═══$(NC)"
	@if command -v shellcheck &>/dev/null; then \
		shellcheck -x $(SCRIPTS) && \
		echo -e "$(GREEN)✓ ShellCheck passed$(NC)"; \
	else \
		echo -e "$(YELLOW)⚠ ShellCheck nu e instalat. Instalează cu: sudo apt install shellcheck$(NC)"; \
	fi

.PHONY: syntax
syntax: ## Verifică sintaxa Bash
	@echo -e "$(YELLOW)═══ Verificare Sintaxă ═══$(NC)"
	@for script in $(SCRIPTS); do \
		bash -n "$$script" && echo -e "$(GREEN)✓$(NC) $$script"; \
	done

.PHONY: test
test: ## Rulează toate testele
	@echo -e "$(YELLOW)═══ Rulare Teste ═══$(NC)"
	@if [ -f "$(TEST_DIR)/run_all.sh" ]; then \
		$(TEST_DIR)/run_all.sh; \
	else \
		passed=0; failed=0; \
		for test in $(TESTS); do \
			if bash "$$test"; then \
				((passed++)); \
			else \
				((failed++)); \
			fi; \
		done; \
		echo ""; \
		echo "Rezultat: $$passed passed, $$failed failed"; \
		[ $$failed -eq 0 ]; \
	fi

.PHONY: test-verbose
test-verbose: ## Rulează testele cu output detaliat
	@echo -e "$(YELLOW)═══ Teste (verbose) ═══$(NC)"
	@for test in $(TESTS); do \
		echo "--- $$test ---"; \
		bash "$$test" || true; \
		echo ""; \
	done

#---------------------------------------
# Instalare
#---------------------------------------

.PHONY: install
install: lint ## Instalează în ~/.local/bin
	@echo -e "$(YELLOW)═══ Instalare ═══$(NC)"
	@mkdir -p $(INSTALL_DIR)
	@cp $(MAIN) $(INSTALL_DIR)/$(NAME)
	@chmod +x $(INSTALL_DIR)/$(NAME)
	@echo -e "$(GREEN)✓ Instalat în $(INSTALL_DIR)/$(NAME)$(NC)"
	@echo ""
	@echo "Asigură-te că $(INSTALL_DIR) e în PATH:"
	@echo "  export PATH=\"$(INSTALL_DIR):\$$PATH\""

.PHONY: uninstall
uninstall: ## Dezinstalează
	@echo -e "$(YELLOW)═══ Dezinstalare ═══$(NC)"
	@rm -f $(INSTALL_DIR)/$(NAME)
	@echo -e "$(GREEN)✓ Dezinstalat$(NC)"

#---------------------------------------
# Curățare
#---------------------------------------

.PHONY: clean
clean: ## Șterge fișiere temporare
	@echo -e "$(YELLOW)═══ Curățare ═══$(NC)"
	@find . -type f -name "*.tmp" -delete
	@find . -type f -name "*.bak" -delete
	@find . -type f -name "*.log" -delete
	@find . -type f -name "*~" -delete
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@echo -e "$(GREEN)✓ Curățat$(NC)"

.PHONY: clean-all
clean-all: clean uninstall ## Curățare completă + dezinstalare

#---------------------------------------
# Packaging
#---------------------------------------

.PHONY: package
package: clean ## Creează arhivă pentru submisie
	@echo -e "$(YELLOW)═══ Împachetare ═══$(NC)"
	@tar --exclude='.git' \
	     --exclude='*.tmp' \
	     --exclude='*.bak' \
	     -czvf ../$(NAME)_$(VERSION).tar.gz .
	@echo -e "$(GREEN)✓ Creat ../$(NAME)_$(VERSION).tar.gz$(NC)"

#---------------------------------------
# Documentație
#---------------------------------------

.PHONY: docs
docs: ## Generează documentație (dacă e cazul)
	@echo -e "$(YELLOW)═══ Documentație ═══$(NC)"
	@echo "Documentația e în $(DOC_DIR)/"
	@ls -la $(DOC_DIR)/ 2>/dev/null || echo "Nu există documentație."

#---------------------------------------
# Info
#---------------------------------------

.PHONY: info
info: ## Afișează informații proiect
	@echo "╔══════════════════════════════════════════════╗"
	@echo "║     Informații Proiect                       ║"
	@echo "╚══════════════════════════════════════════════╝"
	@echo "  Nume:      $(NAME)"
	@echo "  Versiune:  $(VERSION)"
	@echo "  Scripturi: $(words $(SCRIPTS))"
	@echo "  Teste:     $(words $(TESTS))"
	@echo ""
	@echo "Fișiere sursă:"
	@for f in $(SCRIPTS); do echo "  - $$f"; done

.PHONY: loc
loc: ## Numără liniile de cod
	@echo -e "$(YELLOW)═══ Lines of Code ═══$(NC)"
	@wc -l $(SCRIPTS) | tail -1 | awk '{print "Total: " $$1 " linii"}'
	@echo ""
	@wc -l $(SCRIPTS) | sort -n

#---------------------------------------
# Dezvoltare avansată
#---------------------------------------

.PHONY: watch
watch: ## Monitorizează modificări și rulează teste
	@echo "Monitorizare modificări (Ctrl+C pentru oprire)..."
	@while true; do \
		inotifywait -q -e modify $(SCRIPTS) $(TESTS); \
		clear; \
		$(MAKE) test; \
	done

.PHONY: debug
debug: ## Rulează scriptul principal cu debug
	@echo -e "$(YELLOW)═══ Debug Mode ═══$(NC)"
	@bash -x $(MAIN) --help
