#===============================================================================
# Makefile Template - OS Project
# ASE Bucharest - CSIE
#===============================================================================

# Configuration
SHELL := /bin/bash
.SHELLFLAGS := -eu -o pipefail -c

# Project variables
NAME := $(shell basename $(CURDIR))
VERSION := 1.0.0
INSTALL_DIR := $(HOME)/.local/bin

# Directories
SRC_DIR := src
LIB_DIR := $(SRC_DIR)/lib
TEST_DIR := tests
DOC_DIR := docs

# Files
MAIN := $(SRC_DIR)/main.sh
SCRIPTS := $(wildcard $(SRC_DIR)/*.sh) $(wildcard $(LIB_DIR)/*.sh)
TESTS := $(wildcard $(TEST_DIR)/test_*.sh)

# Colours (for nice output)
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m

#---------------------------------------
# Main targets
#---------------------------------------

.PHONY: all
all: lint test ## Full verification (lint + test)

.PHONY: help
help: ## Display this help message
	@echo "╔══════════════════════════════════════════════╗"
	@echo "║     $(NAME) - Makefile Help                  ║"
	@echo "╚══════════════════════════════════════════════╝"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""

#---------------------------------------
# Development
#---------------------------------------

.PHONY: lint
lint: ## Check code quality with ShellCheck
	@echo -e "$(YELLOW)═══ ShellCheck ═══$(NC)"
	@if command -v shellcheck &>/dev/null; then \
		shellcheck -x $(SCRIPTS) && \
		echo -e "$(GREEN)✓ ShellCheck passed$(NC)"; \
	else \
		echo -e "$(YELLOW)⚠ ShellCheck is not installed. Install with: sudo apt install shellcheck$(NC)"; \
	fi

.PHONY: syntax
syntax: ## Check Bash syntax
	@echo -e "$(YELLOW)═══ Syntax Check ═══$(NC)"
	@for script in $(SCRIPTS); do \
		bash -n "$$script" && echo -e "$(GREEN)✓$(NC) $$script"; \
	done

.PHONY: test
test: ## Run all tests
	@echo -e "$(YELLOW)═══ Running Tests ═══$(NC)"
	@if [ -f "$(TEST_DIR)/run_all.sh" ]; then \
		$(TEST_DIR)/run_all.sh; \
	else \
		passed=0; failed=0; \
		for test in $(TESTS); do \
			if bash "$$test"; then \
				((passed++)); \
			else \
				((failed++)); \
			fi; \
		done; \
		echo ""; \
		echo "Result: $$passed passed, $$failed failed"; \
		[ $$failed -eq 0 ]; \
	fi

.PHONY: test-verbose
test-verbose: ## Run tests with detailed output
	@echo -e "$(YELLOW)═══ Tests (verbose) ═══$(NC)"
	@for test in $(TESTS); do \
		echo "--- $$test ---"; \
		bash "$$test" || true; \
		echo ""; \
	done

#---------------------------------------
# Installation
#---------------------------------------

.PHONY: install
install: lint ## Install to ~/.local/bin
	@echo -e "$(YELLOW)═══ Installation ═══$(NC)"
	@mkdir -p $(INSTALL_DIR)
	@cp $(MAIN) $(INSTALL_DIR)/$(NAME)
	@chmod +x $(INSTALL_DIR)/$(NAME)
	@echo -e "$(GREEN)✓ Installed to $(INSTALL_DIR)/$(NAME)$(NC)"
	@echo ""
	@echo "Make sure $(INSTALL_DIR) is in PATH:"
	@echo "  export PATH=\"$(INSTALL_DIR):\$$PATH\""

.PHONY: uninstall
uninstall: ## Uninstall
	@echo -e "$(YELLOW)═══ Uninstallation ═══$(NC)"
	@rm -f $(INSTALL_DIR)/$(NAME)
	@echo -e "$(GREEN)✓ Uninstalled$(NC)"

#---------------------------------------
# Cleanup
#---------------------------------------

.PHONY: clean
clean: ## Delete temporary files
	@echo -e "$(YELLOW)═══ Cleanup ═══$(NC)"
	@find . -type f -name "*.tmp" -delete
	@find . -type f -name "*.bak" -delete
	@find . -type f -name "*.log" -delete
	@find . -type f -name "*~" -delete
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@echo -e "$(GREEN)✓ Cleaned$(NC)"

.PHONY: clean-all
clean-all: clean uninstall ## Full cleanup + uninstall

#---------------------------------------
# Packaging
#---------------------------------------

.PHONY: package
package: clean ## Create archive for submission
	@echo -e "$(YELLOW)═══ Packaging ═══$(NC)"
	@tar --exclude='.git' \
	     --exclude='*.tmp' \
	     --exclude='*.bak' \
	     -czvf ../$(NAME)_$(VERSION).tar.gz .
	@echo -e "$(GREEN)✓ Created ../$(NAME)_$(VERSION).tar.gz$(NC)"

#---------------------------------------
# Documentation
#---------------------------------------

.PHONY: docs
docs: ## Generate documentation (if applicable)
	@echo -e "$(YELLOW)═══ Documentation ═══$(NC)"
	@echo "Documentation is in $(DOC_DIR)/"
	@ls -la $(DOC_DIR)/ 2>/dev/null || echo "No documentation exists."

#---------------------------------------
# Info
#---------------------------------------

.PHONY: info
info: ## Display project information
	@echo "╔══════════════════════════════════════════════╗"
	@echo "║     Project Information                      ║"
	@echo "╚══════════════════════════════════════════════╝"
	@echo "  Name:      $(NAME)"
	@echo "  Version:   $(VERSION)"
	@echo "  Scripts:   $(words $(SCRIPTS))"
	@echo "  Tests:     $(words $(TESTS))"
	@echo ""
	@echo "Source files:"
	@for f in $(SCRIPTS); do echo "  - $$f"; done

.PHONY: loc
loc: ## Count lines of code
	@echo -e "$(YELLOW)═══ Lines of Code ═══$(NC)"
	@wc -l $(SCRIPTS) | tail -1 | awk '{print "Total: " $$1 " lines"}'
	@echo ""
	@wc -l $(SCRIPTS) | sort -n

#---------------------------------------
# Advanced development
#---------------------------------------

.PHONY: watch
watch: ## Monitor changes and run tests
	@echo "Monitoring changes (Ctrl+C to stop)···"
	@while true; do \
		inotifywait -q -e modify $(SCRIPTS) $(TESTS); \
		clear; \
		$(MAKE) test; \
	done

.PHONY: debug
debug: ## Run main script with debug
	@echo -e "$(YELLOW)═══ Debug Mode ═══$(NC)"
	@bash -x $(MAIN) --help
