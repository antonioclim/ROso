
@startuml virtual_address_space
!include ../../diagrams_common/skin.puml
title Virtual Address Space (64-bit Linux)

skinparam rectangle {
    roundCorner 3
}

rectangle "**VIRTUAL ADDRESS SPACE**" as vas #FAFAFA {
    
    rectangle "0xFFFFFFFF...\n**KERNEL SPACE**\n~128 TB" as kernel #FFE0B2 {
        note right
        • Kernel code
        • Drivers
        • Page tables
        end note
    }
    
    rectangle "**NON-CANONICAL GAP**\n(invalid addresses)\nAccess → SEGFAULT" as gap #FFCDD2
    
    rectangle "**USER SPACE** ~128 TB" as user #E3F2FD {
        
        rectangle "**STACK** ↓\n~8 MB default" as stack #FFCDD2 {
            note right
            Local variables
            Function parameters
            Return addresses
            end note
        }
        
        rectangle "⬇️ grows downward" as arrow1 #FFFFFF
        
        rectangle "**MEMORY MAPPED**\n.so libraries\nmmap() regions" as mmap #E1BEE7
        
        rectangle "⬆️ grows upward" as arrow2 #FFFFFF
        
        rectangle "**HEAP** ↑\nmalloc(), new" as heap #FFF9C4 {
            note right
            Dynamic allocation
            brk() extends
            end note
        }
        
        rectangle "**BSS**\nUninitialised global vars\n(zeroed)" as bss #C8E6C9
        
        rectangle "**DATA**\nInitialised global vars" as data #C8E6C9
        
        rectangle "**TEXT (CODE)**\nRead-only, Exec" as text #BBDEFB {
            note right
            Instructions
            Shared on fork
            end note
        }
        
        rectangle "0x00000000\n**RESERVED**\nNULL region" as null #ECEFF1
    }
}

kernel -[hidden]down-> gap
gap -[hidden]down-> user

note bottom of vas
**Linux visualisation:** cat /proc/PID/maps
Each process has its own virtual space!
end note

@enduml
