
@startuml producer_consumer
!include ../../diagrams_common/skin.puml
title Producer-Consumer with Semaphores

skinparam rectangle {
    roundCorner 8
}

rectangle "**BOUNDED BUFFER (N=5)**" as system #FAFAFA {
    
    rectangle "**Producer**" as producer #C8E6C9 {
        note as prod_code
        **Pseudocode:**
        ──────────────
        wait(empty)  // free slot?
        wait(mutex)  // enter CS
        buffer[in] = item
        in = (in+1) % N
        signal(mutex)
        signal(full) // announce element
        end note
    }
    
    rectangle "**Circular Buffer**" as buffer #FFF9C4 {
        rectangle "0" as b0 #FFFFFF
        rectangle "1" as b1 #FFFFFF
        rectangle "2" as b2 #FFFFFF
        rectangle "3" as b3 #FFFFFF
        rectangle "4" as b4 #FFFFFF
        
        note bottom of buffer
        **in** → where the producer places
        **out** → where the consumer takes
        end note
    }
    
    rectangle "**Consumer**" as consumer #E3F2FD {
        note as cons_code
        **Pseudocode:**
        ──────────────
        wait(full)   // element available?
        wait(mutex)  // enter CS
        item = buffer[out]
        out = (out+1) % N
        signal(mutex)
        signal(empty) // announce free slot
        end note
    }
    
    producer -[#27AE60,bold]-> buffer : produce
    buffer -[#3498DB,bold]-> consumer : consume
}

rectangle "**SEMAPHORES**" as sems #FCE4EC {
    rectangle "**empty = N**\n(empty slots)" as empty #C8E6C9
    rectangle "**full = 0**\n(available elements)" as full #E3F2FD
    rectangle "**mutex = 1**\n(exclusive buffer access)" as mutex #FFF9C4
}

note bottom of system
⚠️ **CORRECT wait() ORDER:**
1. wait(empty/full) - check availability
2. wait(mutex) - take the lock

**WRONG**: wait(mutex) then wait(empty) → **DEADLOCK!**
end note

@enduml
