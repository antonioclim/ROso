@startuml fork_copy_on_write
!include ../../diagrame_common/skin.puml
title fork() și Copy-on-Write (CoW)

skinparam rectangle {
    roundCorner 5
}

rectangle "**ÎNAINTE DE fork()**" as before {
    rectangle "Proces Părinte (PID 1000)" as parent1 #E3F2FD {
        rectangle "Page Table" as pt1 #FFFFFF {
            note as pt1_note
            Page 0 → Frame 100
            Page 1 → Frame 101
            Page 2 → Frame 102
            end note
        }
    }
    
    rectangle "Memoria Fizică" as mem1 #C8E6C9 {
        rectangle "Frame 100: code" as f100
        rectangle "Frame 101: data (x=5)" as f101
        rectangle "Frame 102: stack" as f102
    }
    
    parent1 -[#3498DB]-> mem1
}

rectangle "**DUPĂ fork() - CoW ACTIV**" as after #FFF9C4 {
    rectangle "Părinte (PID 1000)" as parent2 #E3F2FD {
        note as pt2_note
        Page 0 → Frame 100
        Page 1 → Frame 101 **[R-O]**
        Page 2 → Frame 102 **[R-O]**
        end note
    }
    
    rectangle "Copil (PID 1001)" as child2 #FCE4EC {
        note as pt3_note
        Page 0 → Frame 100
        Page 1 → Frame 101 **[R-O]**
        Page 2 → Frame 102 **[R-O]**
        end note
    }
    
    rectangle "Memoria Fizică\n(PARTAJATĂ!)" as mem2 #C8E6C9 {
        rectangle "Frame 100: code" as f100b
        rectangle "Frame 101: data" as f101b
        rectangle "Frame 102: stack" as f102b
    }
    
    parent2 -[#3498DB]-> mem2
    child2 -[#E74C3C]-> mem2
    
    note bottom of after
    **Paginile sunt marcate Read-Only!**
    Nu s-a copiat nimic încă.
    end note
}

rectangle "**DUPĂ SCRIERE (copil scrie x=10)**" as write {
    rectangle "Părinte (PID 1000)" as parent3 #E3F2FD {
        note as pt4_note
        Page 1 → Frame 101 [RW]
        (x = 5)
        end note
    }
    
    rectangle "Copil (PID 1001)" as child3 #FCE4EC {
        note as pt5_note
        Page 1 → **Frame 103** [RW]
        (x = 10)
        end note
    }
    
    rectangle "Memoria Fizică" as mem3 #C8E6C9 {
        rectangle "Frame 101:\ndata (x=5)" as f101c #BBDEFB
        rectangle "Frame 103:\ndata (x=10)" as f103c #F8BBD9
    }
    
    parent3 -[#3498DB]-> f101c
    child3 -[#E74C3C]-> f103c
    
    note bottom of write
    **Page Fault → Kernel copiază pagina**
    Acum fiecare are copia proprie
    end note
}

before -[hidden]down-> after
after -[hidden]down-> write

@enduml